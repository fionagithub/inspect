<template>
  <!-- root node required -->
  <div class="layout-view">
    <div class="login">
      <div class="card">
        <div class="card-media">
          <img src="../assets/img/bj_logo.png">
        </div>
        <div class="card-content user">
          <div class="item two-lines">
            <div class="item-content row items-center nowrap">
              <div class="stacked-label">
                <input disabled class="full-width" v-model="tenant">
                <label> {{holderTitle.tenant}}</label>
              </div>
            </div>
              <i class="item-primary conf-icon " @click="setTenant">edit</i>
          </div> 
          <div class="item two-lines">
            <div class="item-content row items-center nowrap">
              <div class="floating-label">
                <input required class="full-width" v-model="users">
                <label> {{holderTitle.user}}</label>
              </div>
            </div>
          </div>  
          <div class="item two-lines">
            <div class="item-content row items-center nowrap">
              <div class="floating-label">
                <input required class="full-width" v-model="pwd" type="password" v-if="showPsd">
                <input required class="full-width" v-model="pwd" type="text" v-if="!showPsd">
                <label> {{holderTitle.pwd}}</label>
              </div>
            </div>
              <i class="item-primary conf-icon " @click="changePwd">visibility</i>
          </div>  
          <div class="login-btn">
            <q-progress-button :disabled="unAddBtn" :percentage="progressBtn" @click.native="login()" indeterminate class="teal circular big">
              登录
            </q-progress-button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>


<script> 
  import { Platform,Toast } from 'quasar'
  import {
    mapActions,
    mapState
  } from 'vuex'
  if(window.isMobile){
    window.JPush.cleanTags({ sequence: 1 },
      (result) => {
        var sequence = result.sequence
      }, (error) => {
        var sequence = error.sequence
        var errorCode = error.code
      })
  }
  export default {
    data() {
      return {
        users:filtersStorage('user'), 
        pwd:filtersStorage('password'), 
       /*  users: '',
         pwd: '', */
        showPsd: true,
        flag: false, 
        progressBtn: 0,
        tenant: filtersStorage('tenantid'),
        holderTitle: {
          tenant: '企业',
          user: '用户名',
          pwd: '密码',
        }
      }
    },
    mounted() {
     window.isIndex=true
    },
    computed: {
      unAddBtn() { 
        return this.flag == true ? true : false
      }
    },
    methods: {
      ...mapActions('auth', [
        'authenticate'
      ]),
      ...mapActions(['setFeathersData']),
      changePwd() {
        this.showPsd = !this.showPsd
      },
      setTenant(){
        this.setFeathersData(false)
        this.$router.push('/config')
      },
      login() {
        let self = this
     //    console.log('[]', self)
        let user = {
          strategy: 'local',
          loginId: self.users,
          password: self.pwd
        }
        self.flag = true
        self.progressBtn = 1
        self.authenticate(user).then(response => {
          self.flag = false
          self.progressBtn = 0
          Toast.create({
            html: '登录成功.',
            timeout: 3000
          })
          let _storage = {
            key: 'user' ,
            value: self.users
          }
          let _storagePsd = {
            key: 'password' ,
            value: self.pwd
          }
            console.log('response:::', response)
         filtersStorage(_storage, 'save')
          filtersStorage(_storagePsd, 'save')
          let url=this.$route.query.redirect||'/index'
          self.$router.push(url)
        }).catch(function (error) {
          let msg
          if(String(error)=="Error: Socket connection timed out"){
             msg="服务连接错误"
          }else{
            msg= '登录出错，请稍后再试'
          }
            self.flag = false
            self.progressBtn = 0
            Toast.create.negative({
              html: msg,
              timeout: 13000
            })
            console.error('-----',error);
        });
      }
    }
  }

</script>

<style>
  .login {
    height: 100vh;
  }
  
  .login .user {
    padding: 20px 50px;
  }


  .login .card {
    height: 100vh;
    margin: 0;
  }

  .login .item-lines {
    padding: 10px;
  }

  .login .item-label {
    margin-right: 10px;
    width: 60px;
  }

  .login .login-btn {
    padding: 50px;
    display: flex;
    justify-content: center;
  }
  .conf-icon{
    right: 4px;
    font-size: 1rem;
    left: auto!important;
  } 
</style>
